<?php

/**
 * Implements hook_views_query_alter().
 * fix to read the date argument which was otherwise not parsed
 */
function gc_custom_views_query_alter(&$view, &$query) {

  // (Example assuming a view with an exposed filter on node title.)
  // If the input for the title filter is a positive integer, filter against
  // node ID instead of node title.
  if ($view->name == 'concerts' && $view->current_display == 'home_list') {
    $selected_date = $view->args[1];
    if($selected_date){
      $view->query->add_where_expression(
        1,
        "DATE_FORMAT(field_data_field_date.field_date_value, '%Y-%m-%d') = :field_data_field_date_field_date_value_2", 
        array(':field_data_field_date_field_date_value_2' => $selected_date)
      );
    }
  }
}


/*
 * provide link formatter to show buy/acheter links
 */
function gc_custom_field_formatter_info() {
  $info['buy_link'] = array(
    'label' => t('Display link as "BUY"'),
    'field types' => array('link_field'),
    'module' => 'gc_custom',
    'settings' => array(
      'format' => 'hi',
    ),
  );
  return $info;
}
function gc_custom_field_formatter_view($entity_type, $entity, $field, $instance, $langcode, $items, $display) {
  $element = array(); // Initialize the var
  $settings = $display['settings']; // get the settings
  $options = array(
    'html'        => TRUE, // This tells Drupal that we're sending HTML, not plain text, otherwise it would encode it
    'attributes'  => array(
      //'title' => $tooltip, // This sets our tooltip
      ),
    );
    foreach($items as $index => $item)
    {
      $element[$index]['#type'] = 'markup';
      $link = '<a href="' . $item['url'] . '" target="_blank">' . t('Buy') . '</a>';
      $element[$index]['#markup'] = $link; // Assign it to the #markup of the element
    }
    $element['#prefix'] = '<div class="buy-link">';
    $element['#suffix'] = '</div>';
  return $element;
}